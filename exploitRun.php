<?php

session_start();

include 'functions.php';

$ip = $_POST['ip'];

if ($ip === '') {
    echo "Error in the ip";
    exit();
}


//Secure Renegotation
$secure = secureRenegotation($ip);
saveResult($ip, 'secure_renegotation', $secure);
//RC4
$rc4 = rc4($_SESSION['rc4']);
saveResult($ip, 'rc4', $rc4);
//Foward Secrecy
$fs = fowardSecrecy($_SESSION['fs']);
saveResult($ip, 'forward_secrecy', $fs);
//Downgrade
$scsv = downgradeAttack($ip);
saveResult($ip, 'downgrade_prevention', $scsv);
//Freak
$freak = freakAttack($_SESSION['freak']);
saveResult($ip, 'freak', $freak);
//Poodle SSL3
$poodleSSL3 = poodleSSL3($_SESSION['freak'], $_SESSION['ssl3']);
saveResult($ip, 'poodle_ssl3', $poodleSSL3);
//Poodle TLS
$poodleTLS = poodleTLS($_SESSION['freak'], $_SESSION['tls'], $_SESSION['tls1.1'], $_SESSION['tls1.2']);
saveResult($ip, 'poodle_tls', $poodleTLS);
//BEAST
$beast = BeastAttack($_SESSION['freak'], $_SESSION['tls']);
saveResult($ip, 'beast', $beast);
//Prueba
//DrownAttack($ip);
//Heartbeat exension
$heartbeat_ext = heartbeatExtension($ip);
saveResult($ip, 'heartbeat_extension', $heartbeat_ext);

//Create the table
echo '<div id="tab_ip" class="form-content"><div id="tab" class="ssl wrap1">';
echo "<h2 class='title'>Attacks:</h2><table>";

if ($secure === 'No') {
    echo "<tr class='grey'><td class='left second' style='color: red;'>Secure Renegotation</td><td class='right second' style='color: red;'>No</td></tr>";
} else if ($secure === 'Yes') {
    echo "<tr class='grey'><td class='left second' style='color: green;'>Secure Renegotation</td><td class='right second' style='color: green;'>Yes</td></tr>";
} else {
    echo "<tr class='grey'><td class='left second' style='color: orange;'>Secure Renegotation</td><td class='right second' style='color: orange;'>Unknown</td></tr>";
}

if ($rc4 === 'Yes') {
    echo "<tr class='grey'><td class='left second' style='color: red;'>RC4</td><td class='right second' style='color: red;'>Yes - INSECURE</td></tr>";
} else {
    echo "<tr class='grey'><td class='left second'>RC4</td><td class='right second'>No</td></tr>";
}

if ($fs === 'Yes') {
    echo "<tr class='grey'><td class='left second' style='color: orange;'>Foward Secrecy</td><td class='right second' style='color: orange;'>Yes, with some browsers</td></tr>";
} else if ($fs === 'Yes-new') {
    echo "<tr class='grey'><td class='left second' style='color: green;'>Foward Secrecy</td><td class='right second' style='color: green;'>Yes, with new browsers</td></tr>";
} else {
    echo "<tr class='grey'><td class='left second' style='color: orange;'>Foward Secrecy</td><td class='right second' style='color: orange;'>No - Week</td></tr>";
}

if ($scsv === 'Yes') {
    echo "<tr class='grey'><td class='left second' style='color: green;'>Downgrade Prevention Attack</td><td class='right second' style='color: green;'>Yes</td></tr>";
} else if ($scsv === 'No') {
    echo "<tr class='grey'><td class='left second'>Downgrade Prevention Attack</td><td class='right second'>No</td></tr>";
} else {
    echo "<tr class='grey'><td class='left second' style='color: orange;'>Downgrade Prevention Attack</td><td class='right second' style='color: orange;'>Unknown</td></tr>";
}

if ($freak === 'Yes') {
    echo "<tr class='grey'><td class='left second' style='color: red;'>Freak</td><td class='right second' style='color: red;'>Yes - INSECURE</td></tr>";
} else {
    echo "<tr class='grey'><td class='left second'>Freak</td><td class='right second'>No</td></tr>";
}

if ($poodleSSL3 === 'Yes') {
    echo "<tr class='grey'><td class='left second' style='color: red;'>POODLE (SSLv3)</td><td class='right second' style='color: red;'>Yes - INSECURE</td></tr>";
} else {
    echo "<tr class='grey'><td class='left second'>POODLE (SSLv3)</td><td class='right second'>No</td></tr>";
}

if ($poodleTLS === 'Yes') {
    echo "<tr class='grey'><td class='left second' style='color: red;'>POODLE (TLS)</td><td class='right second' style='color: red;'>Yes - INSECURE</td></tr>";
} else {
    echo "<tr class='grey'><td class='left second'>POODLE (TLS)</td><td class='right second'>No</td></tr>";
}

if ($beast === 'Yes') {
    echo "<tr class='grey'><td class='left second' style='color: red;'>Beast</td><td class='right second' style='color: red;'>Yes - INSECURE</td></tr>";
} else {
    echo "<tr class='grey'><td class='left second'>Beast</td><td class='right second'>No</td></tr>";
}

if ($heartbeat_ext === 'Yes') {
    echo "<tr class='grey'><td class='left second' style='color: green;'>Heartbeat Extension</td><td class='right second' style='color: green;'>Yes</td></tr>";
} else if ($heartbeat_ext === 'No') {
    echo "<tr class='grey'><td class='left second'>Heartbeat Extension</td><td class='right second'>No</td></tr>";
} else {
    echo "<tr class='grey'><td class='left second' style='color: orange;'>Heartbeat Extension</td><td class='right second' style='color: orange;'>Unknown</td></tr>";
}


$params = getExploits();

for ($i = 0; $i < count($params); $i++) {
    createFile("./exploit/txt/" . $params[$i]['name'] . "_" . $ip . ".txt");
    exec("python ./exploit/" . $params[$i]['idparent'] . "/" . $params[$i]['name'] . "/" . $params[$i]['name'] . ".py " . $ip . " > ./exploit/txt/" . $params[$i]['name'] . "_" . $ip . ".txt");
    usleep(100);

    //Check if the host is vulnerable to the exploit
    $check = checkExploit("./exploit/txt/" . $params[$i]['name'] . "_" . $ip . ".txt");
    //Save statistics in database
    saveResult($ip, $params[$i]['name'], $check);
    if ($check === 'Yes') {
        echo "<tr class='grey'><td class='left second' style='color: red;'>" . $params[$i]['name'] . "</td><td class='right second' style='color: red;'>Yes - INSECURE</td></tr>";
    } else if ($check === 'No') {
        echo "<tr class='grey'><td class='left second'>" . $params[$i]['name'] . "</td><td class='right second'>No</td></tr>";
    } else {
        echo "<tr class='grey'><td class='left second' style='color: orange;'>" . $params[$i]['name'] . "</td><td class='right second' style='color: orange;'>" . $check . "</td></tr>";
    }
}

echo '</table></div></div>';
?>
