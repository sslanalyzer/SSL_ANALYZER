
$(document).ready(function() {


    if ($('h2')[0] !== undefined && $('h2')[0].textContent !== 'Exploits list:') {
        updateExploit();
    } else {

        listExploits();
        var count = 0;
        var count1 = 0;
        if ($('div#tab1').hasClass('active')) {

            var formulario = document.getElementById('form1');
            var elementos = formulario.elements;
            // Funcion que se ejecuta cuando el evento click es activado

            var validarInputs = function() {


                if (!/^[a-zA-Z0-9 ]+$/.test(elementos.name.value)) {
                    console.log('El campo ' + elementos.name.name + ' debe ser letras y numeros');
                    elementos.name.value = "";
                    elementos.name.className = elementos.name.className + " error";
                    $('.error_title').html("The name must be only letters and numbers");
                    elementos.name.value = "";
                    elementos.name.className = elementos.name.className + " error";
                    $('.error_title').show();
                    return false;
                }

                if (elementos.name.value.length >= 15) {
                    console.log('El campo ' + elementos.name.name + ' es demasiado largo');
                    elementos.name.value = "";
                    elementos.name.className = elementos.name.className + " error";
                    $('.error_title').html("Name too long (max 14)");
                    $('.error_title').show();
                    return false;
                } else {
                    elementos.name.className = elementos.name.className.replace(" error", "");
                }

                if (elementos.exploit.value.length == 0) {
                    console.log('El campo ' + elementos.exploit.name + ' esta vacÃ­o');
                    elementos.exploit.className = elementos.exploit.className + " error";
                    $('.error_title').html("Text area exploit is empty");
                    $('.error_title').show();
                    return false;
                }
                $('.error_title').hide();
                return true;
            };
            var exploit =
                    function addExploit() {
                        var formulario = document.getElementById('form1');
                        var elementos = formulario.elements;
                        var upgrade = $('#upgrade')[0].checked;
                        $.ajax({
                            data: {name: elementos.name.value,
                                description: elementos.description.value,
                                file: elementos.exploit.value,
                                upgrade: upgrade,
                            },
                            url: 'addExploit.php',
                            type: 'post',
                            beforeSend: function() {
                                //$("h2.title_two").html("Procesando, espere por favor...");
                            },
                            success: function(response) {
                                //$('.error').show();

                                $('.error_title').html(response)
                                if ($('.error_title').text().indexOf("Error: The name") >= 0) {
                                    elementos.name.value = "";
                                    elementos.name.className = elementos.name.className + " error";
                                    $('.error_title').show();
                                } else if ($('.error_title').text().indexOf("Error:") >= 0) {
                                    $('.error_title').show();
                                } else {
                                    $('.error_title').hide();
                                    $('div.btn-login').hide();
                                    $('div.wrap').html(response);
                                    myVar = setTimeout(redirect, 3000);
                                }
                            }});
                    }

            var enviar = function(e) {
                if (!validarInputs()) {
                    console.log('Falto validar los Input');
                    e.preventDefault();
                } else {
                    if (!exploit()) {
                        console.log('Error al logear');
                        e.preventDefault();
                    } else {
                        console.log('Envia');
                        e.preventDefault();
                    }
                }
            };
            var focusInput = function() {
                this.parentElement.children[1].className = "label active";
                this.parentElement.children[0].className = this.parentElement.children[0].className.replace("error", "");
                if (this.parentElement.children[0].type == "textarea")
                    this.parentElement.children[0].value = "";
            };
            var blurInput = function() {
                if (this.value <= 0) {
                    this.parentElement.children[1].className = "label";
                    this.parentElement.children[0].className = this.parentElement.children[0].className + " error";
                    if (this.parentElement.children[0].type == "textarea")
                        this.parentElement.children[0].value = "";
                }
            };
            formulario.addEventListener("submit", enviar);
            for (var i = 0; i < elementos.length; i++) {
                if (elementos[i].type == "text") {
                    elementos[i].addEventListener("focus", focusInput);
                    elementos[i].addEventListener("blur", blurInput);
                }
            }

//-----------------------------------------

        }

        $("#exploit.textarea").click(function() {
            if (count === 0)
                this.value = "";
            count++;
        });
        $("#description.textarea").click(function() {
            if (count1 === 0)
                this.value = "";
            count1++;
        });
    }
});
function getInfo() {
    $('div.emergent').show();
}

function close_aside() {
    $('div.emergent').hide();
}


function redirect() {
    location.href = 'exploits.html';
}

function listExploits() {
    $.ajax({
        data: {},
        url: 'listExploits.php',
        type: 'post',
        beforeSend: function() {
            //$("h2.title_two").html("Procesando, espere por favor...");
        },
        success: function(response) {
            //$('.error').show();

            $('.error_title').html(response);
            if ($('.error_title').text().indexOf("Error: The name") >= 0) {
                elementos.name.value = "";
                elementos.name.className = elementos.name.className + " error";
                $('.error_title').show();
            } else if ($('.error_title').text().indexOf("Error:") >= 0) {
                $('.error_title').show();
            } else {
                $('.error_title').hide();
                $('div.btn-login').hide();
                $('ul#ul.head').html(response);
                isSuperadmin();
            }
        }});
}

function infoExploit(id) {

    if ($.isNumeric(id) === true)
        var name = $('li#li' + id + ' a')[0].innerHTML;
    else
        var name = id;
    $.ajax({
        data: {name: name},
        url: 'infoExploit.php',
        type: 'post',
        beforeSend: function() {
            //$("h2.title_two").html("Procesando, espere por favor...");
        },
        success: function(response) {
            //$('.error').show();

            $('.error_title').html(response);

            if ($('.error_title').text().indexOf("Error:") >= 0) {
                $('.error_title').show();
            } else {
                $('.error_title').hide();
                $('div.new-exploit').hide();
                if ($.isNumeric(id) === true)
                    $('div.list-exploits').html(response);
                else {
                    $('div.emergent.exploit').remove();
                    $('footer.footer').append('<div class="emergent exploit">\n\
                <div><span class="close" title="Cerrar"><img class="cross" src="fonts/cross.png" alt="Close" onclick="close_aside();return false;">\n\
</span></div>' + response + '</div>');
                }
            }
        }});
}


function isSuperadmin() {
    var pag = "'update.html'";
    $.ajax({
        data: {},
        url: 'isSuperadmin.php',
        type: 'post',
        beforeSend: function() {
            //$("h2.title_two").html("Procesando, espere por favor...");
        },
        success: function(response) {
            if (response === '1') {
                $('div.new-exploit').append('<div class="separator"></div><br><div><div class="btn-exploit2">\n\
<input type="submit" id="btn-submit" value="Update the database" onclick="update()">\n\
</div></div>');
            }
        }});
}

function update() {

    $.ajax({
        data: {},
        url: 'update.php',
        type: 'post',
        beforeSend: function() {
            //$("h2.title_two").html("Procesando, espere por favor...");
        },
        success: function(response) {
            $('.error_title').html(response);

            if ($('.error_title').text().indexOf("No data") >= 0) {
                $('.error_title').show();
            } else {
                $('.error_title').hide();
                $('section').html(response);
            }
        }});
}

function updateExploit() {

    var formulario = document.getElementById('form1');
    var elementos = formulario.elements;
    var count = 0;
    $('h3.error_title').hide();

    for (var i = 0; i < elementos.length; i++) {
        if (elementos[i].type === "checkbox") {
            if (elementos[i].checked) {
                count++;
                $.ajax({
                    data: {name: elementos[i].name},
                    url: 'refreshDatabase.php',
                    type: 'post',
                    beforeSend: function() {
                        //$("h2.title_two").html("Procesando, espere por favor...");
                    },
                    success: function(response) {
                        if (response !== '') {
                            $('h2').append('<h3 class="error_title">Error</h3>');
                            return false;
                        }
                        $('title').append(response);
                    }});
            }
        }
    }
    if (count === '0') {
        $('h3.error_title').html('Error, choose at least one exploit to update');
        $('h3.error_title').show();
        return false;
    }
    update();
}