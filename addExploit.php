<?php

session_start();

$name = $_POST['name'];
$description = $_POST['description'];
$file = $_POST['file'];
$upgrade = $_POST['upgrade'];

if (isset($_SESSION['username'])) {
    $dir = __DIR__ . "/exploit";

    $name = str_replace(' ', '_', $name);

    //Conection to database
    $conn = pg_connect("host=localhost dbname=SSL_ANALYZER user=alumnodb password=alumnodb") or die('No pudo conectarse: ' . pg_last_error());

    //Check if the name exist
    $consulta = "SELECT * FROM exploit WHERE name = '" . $name . "';";
    $resultado = pg_query($conn, $consulta) or die('Consulta fallida: ' . pg_last_error());
    $linea = pg_fetch_row($resultado, null, PGSQL_ASSOC);

    //Check if the field upgrade is checked
    if ($upgrade == 'true') {
        if ($linea['name'] != '' && $linea['idparent'] == $_SESSION['username']) {
            $exploitFile = fopen("exploit/" . $_SESSION['username'] . "/" . $name . "/" . $name . ".py", "w") or die("Unable to open file!");
            fwrite($exploitFile, $file);
            fclose($exploitFile);
            exit();
        } else {
            if ($linea['name'] == '')
                echo 'Error: The name ' . $name . ' doesnt exist';
            else if ($linea['idparent'] != $_SESSION['username'])
                echo 'Error: The user name ' . $_SESSION['username'] . ' doesnt have this expploit name ' . $name;
            exit();
        }
    }

    if ($linea['name'] != '') {
        echo 'Error: The name ' . $name . ' is used';
        exit();
    }

    if (!file_exists($dir)) {
        exec("chmod -R 777 " . __DIR__);
        if (mkdir($dir, 0777, true)) {
            exec("chmod -R 777 " . __DIR__);
            if (mkdir($dir . "/" . $_SESSION['username'], 0777, true)) {
                exec("chmod -R 777 " . $dir . "/" . $_SESSION['username']);
                mkdir($dir . "/" . $_SESSION['username'] . "/" . $name, 0777);
                chmod($dir . "/" . $_SESSION['username'] . "/" . $name, 0777);
            } else {
                echo 'Error: Cant create the exploit subfolder';
                exit();
            }
        } else {
            echo 'Error: Cant create the exploit folder';
            exit();
        }
    } else {
        if (!file_exists($dir . "/" . $_SESSION['username'])) {
            exec("chmod -R 777 " . $dir);
            if (mkdir($dir . "/" . $_SESSION['username'], 0777, true)) {
                exec("chmod -R 777 " . $dir);
                mkdir($dir . "/" . $_SESSION['username'] . "/" . $name, 0777);
                chmod($dir . "/" . $_SESSION['username'] . "/" . $name, 0777);
            } else {
                echo 'Error: Cant create the exploit subfolder';
                exit();
            }
        } else {
            exec("chmod -R 777 " . $dir);
            mkdir($dir . "/" . $_SESSION['username'] . "/" . $name, 0777);
            chmod($dir . "/" . $_SESSION['username'] . "/" . $name, 0777);
        }
        exec("chmod -R 777 " . $dir);
    }
    //echo "Error: touch " . $dir . "/" . $_SESSION['username'] . "/" . $name . "/" . $name, ".py";
    if (touch("exploit/" . $_SESSION['username'] . "/" . $name . "/" . $name . ".py") == FALSE) {
        echo 'Error: impossible to create the file';
    } else {
        exec("chmod -R 777 " . $dir . "/" . $_SESSION['username'] . "/" . $name);
        //Create the file and save
        $exploitFile = fopen("exploit/" . $_SESSION['username'] . "/" . $name . "/" . $name . ".py", "w") or die("Unable to open file!");
        fwrite($exploitFile, $file);
        fclose($exploitFile);
    }
    $consulta = "INSERT INTO exploit VALUES ('" . $name . "', '" . $_SESSION['username'] . "', '" . date("Y-m-d H:i:s") . "', '" . $description . "', '0')";
    $resultado = pg_query($conn, $consulta) or die('Failed: ' . pg_last_error());
    echo '<div class="correct_register"><h2>The exploit has been created successfully </h2><br>Redirecting...</div>';
    exit();
} else {
    echo 'Error: you must be logged';
}
?>